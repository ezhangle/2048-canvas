$.fn.make2048=function(h){var b={width:4,height:4,style:{background_color:"rgb(184,175,158)",block_background_color:"rgb(204,192,178)",padding:27,block_size:150,block_style:{"font-family":"微软雅黑","font-weight":"bold","text-align":"center"}},blocks:[{level:0,value:2,style:{"background-color":"rgb(238,228,218)","color":"rgb(124,115,106)","font-size":58}},{level:1,value:4,style:{"background-color":"rgb(236,224,200)","color":"rgb(124,115,106)","font-size":58}},{level:2,value:8,style:{"background-color":"rgb(242,177,121)","color":"rgb(255,247,235)","font-size":58}},{level:3,value:16,style:{"background-color":"rgb(245,149,99)","color":"rgb(255,250,235)","font-size":50}},{level:4,value:32,style:{"background-color":"rgb(244,123,94)","color":"rgb(255,247,235)","font-size":50}},{level:5,value:64,style:{"background-color":"rgb(247,93,59)","color":"rgb(255,247,235)","font-size":50}},{level:6,value:128,style:{"background-color":"rgb(236,205,112)","color":"rgb(255,247,235)","font-size":42}},{level:7,value:256,style:{"background-color":"rgb(237,204,97)","color":"rgb(255,247,235)","font-size":42}},{level:8,value:512,style:{"background-color":"rgb(236,200,80)","color":"rgb(255,247,235)","font-size":42}},{level:9,value:1024,style:{"background-color":"rgb(237,197,63)","color":"rgb(255,247,235)","font-size":34}},{level:10,value:2048,style:{"background-color":"rgb(238,194,46)","color":"rgb(255,247,235)","font-size":34}},{level:11,value:4096,style:{"background-color":"rgb(61,58,51)","color":"rgb(255,247,235)","font-size":34}}],animateSpeed:300};var c=[];h=$.extend({},b,h);if(this.length>1){throw"一次只能开始一个游戏"}if(this.length=0){throw"未找到游戏容器"}var f=$(this[0]);f.css({"background-color":h.style.background_color,"border-radius":h.style.padding,"position":"relative","-webkit-user-select":"none"});var m=function(v){return{x:v%h.width,y:Math.floor(v/h.width)}};var p=function(v,w){return v+w*h.width};var s=function(v,w){return{"top":h.style.padding+w*(h.style.block_size+h.style.padding),"left":h.style.padding+v*(h.style.block_size+h.style.padding)}};var a=function(){var v=[];$(c).each(function(w,x){if(x==null){v.push(w)}});return v};var r=function(v,w){return c[p(v,w)]};var k=function(){var A=[];for(var w=0;w<h.width;w++){for(var B=0;B<h.height;B++){c.push(null);var z=$("<div></div>");var v=s(w,B);z.css({"width":h.style.block_size,"height":h.style.block_size,"background-color":h.style.block_background_color,"position":"absolute","top":v.top,"left":v.left});A.push(z)}}f.append(A);f.width((h.style.block_size+h.style.padding)*h.width+h.style.padding);f.height((h.style.block_size+h.style.padding)*h.height+h.style.padding)};var o=function(v,E,D){var A=a();if(A.length==0){return false}var w;if(E!=undefined&&D!=undefined){w=p(E,D)}else{w=A[Math.floor(Math.random()*A.length)]}if(c[w]!=null){throw"已经有块存在"}var z;if(v!=undefined){z=$.extend({},h.blocks[v])}else{z=$.extend({},Math.random()>=0.5?h.blocks[0]:h.blocks[1])}var G=m(w);var B=s(G.x,G.y);var F=$("<div></div>");F.addClass("block_"+G.x+"_"+G.y);F.css($.extend(h.style.block_style,{"position":"absolute","top":B.top+h.style.block_size/2,"left":B.left+h.style.block_size/2,"width":0,"height":0},z.style));f.append(F);c[w]=z;F.animate({"width":h.style.block_size,"height":h.style.block_size,"top":B.top,"left":B.left,"line-height":h.style.block_size+"px"},h.animateSpeed,(function(x){return function(){x.html(z.value)}})(F));if(A.length==1){var C=false;for(var E=0;E<h.width-1&&!C;E++){for(var D=0;D<h.height-1&&!C;D++){if(E>0&&c[p(E-1,D)].value==c[p(E,D)].value){C=true}if(E<h.width&&c[p(E+1,D)].value==c[p(E,D)].value){C=true}if(D>0&&c[p(E,D-1)].value==c[p(E,D)].value){C=true}if(D<h.height&&c[p(E,D+1)].value==c[p(E,D)].value){C=true}}}if(!C){u();return false}}return true};var q=0;var n=function(N){if(new Date()-q<h.animateSpeed+20){return}q=new Date();var M,L,w,v,A,z;var H=false;switch(N){case"up":M=0;w=h.width-1;L=1;v=h.height-1;A=0;z=-1;break;case"down":M=0;w=h.width-1;L=h.height-2;v=0;A=0;z=1;break;case"left":M=1;w=h.width-1;L=0;v=h.height-1;A=-1;z=0;break;case"right":M=h.width-2;w=0;L=0;v=h.height-1;A=1;z=0;break}for(var G=M;G<=Math.max(M,w)&&G>=Math.min(M,w);w>M?G++:G--){for(var F=L;F<=Math.max(L,v)&&F>=Math.min(L,v);v>L?F++:F--){var E=r(G,F);if(E==null){continue}var I={x:G,y:F};var K;var C=0;do{if(++C>Math.max(h.width,h.height)){break}I.x+=A;I.y+=z;K=r(I.x,I.y);if(N=="up"||N=="down"){if(I.y==0||I.y==h.height-1){break}}if(N=="left"||N=="right"){if(I.x==0||I.x==h.width-1){break}}}while(K==null);var J=$(".block_"+G+"_"+F);if(K==null){var O=s(I.x,I.y);c[p(G,F)]=null;c[p(I.x,I.y)]=E;J.removeClass();J.addClass("block_"+I.x+"_"+I.y);J.animate({"top":O.top,"left":O.left},h.animateSpeed)}else{if(K.value==E.value&&!K.justModified){var O=s(I.x,I.y);var D=$.extend({},h.blocks[E.level+1]);if(D.level==h.blocks.length-1){u()}D.justModified=true;c[p(G,F)]=null;c[p(I.x,I.y)]=D;var B=$(".block_"+I.x+"_"+I.y);J.animate({"top":O.top,"left":O.left},h.animateSpeed,(function(Q,x,P,y){return function(){Q.remove();x.html(y.value);
x.css(y.style)}}(J,B,I,D)))}else{if(K.value!=E.value||C>1){I.x=I.x-A;I.y=I.y-z;if(I.x==G&&I.y==F){continue}var O=s(I.x,I.y);c[p(G,F)]=null;c[p(I.x,I.y)]=E;J.removeClass();J.addClass("block_"+I.x+"_"+I.y);J.animate({"top":O.top,"left":O.left},h.animateSpeed)}else{continue}}}H=true}}for(var G=0;G<h.width;G++){for(var F=0;F<h.height;F++){var E=r(G,F);if(E==null){continue}delete E.justModified}}if(H){o()}};var t=function(v){switch(v.which){case 38:n("up");break;case 40:n("down");break;case 37:n("left");break;case 39:n("right");break}};var j=null;var d=function(v){if(v.type=="mousedown"&&j==null){j={x:v.pageX,y:v.pageY}}if(v.type=="mouseup"){var x=v.pageX-j.x;var w=v.pageY-j.y;if(Math.abs(x)+Math.abs(w)>20){if(Math.abs(x)>=Math.abs(w)){if(x>0){n("right")}else{n("left")}}else{if(w>0){n("down")}else{n("up")}}}j=null}};var g=null;var i=function(v){if(v.type=="touchstart"&&g==null){v.preventDefault();g={x:v.targetTouches[0].pageX,y:v.targetTouches[0].pageY}}if(v.type=="touchmove"){v.preventDefault();var x=v.targetTouches[0].pageX-g.x;var w=v.targetTouches[0].pageY-g.y;if(Math.abs(x)+Math.abs(w)>10){if(Math.abs(x)>=Math.abs(w)){if(x>0){n("right")}else{n("left")}}else{if(w>0){n("down")}else{n("up")}}}g=null}};var l=new Hammer(document.getElementById("game"));l.get("swipe").set({direction:Hammer.DIRECTION_ALL});var e=function(){$(document).on("keydown",t);$(document).on("mousedown",d);$(document).on("mouseup",d);l.on("swipeleft",function(){n("left")});l.on("swiperight",function(){n("right")});l.on("swipeup",function(){n("up")});l.on("swipedown",function(){n("down")});f.html("");c=[];k();o();o()};var u=function(){$(document).off("keydown",t);$(document).off("mousedown",d);$(document).off("mouseup",d);var C=0;for(var z=0;z<c.length;z++){if(c[z]==null){continue}C+=c[z].value}console.log("游戏结束, 您的分数为:",C);var y=$("<div></div>");var B=$("<div></div>");B.css({"background-color":h.style.background_color,"border-radius":h.style.padding,"position":"absolute","-webkit-user-select":"none","opacity":0.5,"width":f.width(),"height":f.height()});var x=$("<div></div>");var A=$("<h1>游戏结束</h1>");var w=$("<p>您的分数为:"+C+"</p>");var v=$("<button>再玩一次</button>");v.click(function(D){D.preventDefault();e()});x.css({"width":"200px","text-align":"center","margin":"0 auto","position":"absolute","top":"50%","transform":"translate(-50%, -50%)","left":"50%","padding":20,"background-color":h.style.block_background_color});y.append(B);x.append(A);x.append(w);x.append(v);y.append(x);f.append(y)};e()};